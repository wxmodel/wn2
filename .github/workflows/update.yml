name: WeatherNext Auto-Runner

on:
  push:
    branches:
      - main
  schedule:
    # Run 30 minutes after typical WN2 EE publish times
    - cron: "0 2 * * *"   # after 18z cycle
    - cron: "0 8 * * *"   # after 00z cycle
    - cron: "0 14 * * *"  # after 06z cycle
    - cron: "0 20 * * *"  # after 12z cycle
  workflow_dispatch:
    inputs:
      preview_one_frame:
        description: "Generate one frame per product (quick preview)"
        required: false
        default: false
        type: boolean
      hours_csv:
        description: "Optional explicit forecast hours (e.g. 6,12,18)"
        required: false
        default: ""
        type: string
      run_nh_z500a:
        description: "Generate NH 500mb anomaly"
        required: false
        default: true
        type: boolean
      run_na_z500a:
        description: "Generate NA 500mb anomaly"
        required: false
        default: true
        type: boolean
      run_conus_mslp_ptype:
        description: "Generate CONUS MSLP + P-Type"
        required: false
        default: true
        type: boolean
      run_ne_mslp_ptype:
        description: "Generate Northeast MSLP + P-Type"
        required: false
        default: true
        type: boolean
      run_conus_vort500:
        description: "Generate CONUS 500mb vorticity"
        required: false
        default: true
        type: boolean
      run_conus_snow_accum:
        description: "Generate CONUS snowfall accumulation"
        required: false
        default: true
        type: boolean
      run_ne_snow_accum:
        description: "Generate Northeast snowfall accumulation"
        required: false
        default: true
        type: boolean
  
concurrency:
  group: wn2-pages
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "requirements.txt"

      - name: Install Libraries
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Map Generator
        env:
          EE_KEY: ${{ secrets.EE_KEY }}
          EE_PROJECT: ${{ secrets.EE_PROJECT }}
          HOURS_MAX: ${{ (github.event_name == 'schedule' || github.event_name == 'push') && '240' || '' }}
          HOURS_LIMIT: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.preview_one_frame == 'true' && '1' || '' }}
          HOURS_CSV: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.hours_csv || '' }}
          FAST_RENDER: ${{ (github.event_name == 'schedule' || github.event_name == 'push') && '1' || '' }}
          EXPORT_WORKERS: ${{ (github.event_name == 'schedule' || github.event_name == 'push') && '2' || '2' }}
          WN2_RUN_NH_Z500A: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.run_nh_z500a == 'true' && '1' || '') || '1' }}
          WN2_RUN_NA_Z500A: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.run_na_z500a == 'true' && '1' || '') || '1' }}
          WN2_RUN_CONUS_MSLP_PTYPE: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.run_conus_mslp_ptype == 'true' && '1' || '') || '1' }}
          WN2_RUN_NE_MSLP_PTYPE: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.run_ne_mslp_ptype == 'true' && '1' || '') || '1' }}
          WN2_RUN_CONUS_VORT500: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.run_conus_vort500 == 'true' && '1' || '') || '1' }}
          WN2_RUN_CONUS_SNOW_ACCUM: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.run_conus_snow_accum == 'true' && '1' || '') || '1' }}
          WN2_RUN_NE_SNOW_ACCUM: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.run_ne_snow_accum == 'true' && '1' || '') || '1' }}
        run: python main.py

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
